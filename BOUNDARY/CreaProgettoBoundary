package com.uninabiogarden.oobd68.boundary;

import com.uninabiogarden.oobd68.controller.Controller;
import com.uninabiogarden.oobd68.entity.Coltura;
import com.uninabiogarden.oobd68.entity.Lotto;

import javax.swing.*;
import java.awt.*;
import java.util.ArrayList;
import java.util.List;

public class CreaProgettoBoundary extends JFrame {

    private Controller controller;
    private JTextField txtIdLotto, txtSuperficie, txtOrtaggio;
    private DefaultListModel<String> listModel;
    private List<Coltura> listaColtureTemp;

    public CreaProgettoBoundary(Controller controller) {
        this.controller = controller;
        this.listaColtureTemp = new ArrayList<>();

        setTitle("Crea Nuovo Progetto - Unina BioGarden");
        setSize(500, 400);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE); // Chiude solo questa finestra, non tutto il programma
        setLocationRelativeTo(null);
        setLayout(new BorderLayout(10, 10));

        // --- Pannello Input Dati (Nord) ---
        JPanel panelInput = new JPanel(new GridLayout(4, 2, 5, 5));
        panelInput.setBorder(BorderFactory.createEmptyBorder(10, 10, 0, 10)); // Margini

        panelInput.add(new JLabel("ID Lotto (Numerico):"));
        txtIdLotto = new JTextField();
        panelInput.add(txtIdLotto);

        panelInput.add(new JLabel("Superficie (mq):"));
        txtSuperficie = new JTextField();
        panelInput.add(txtSuperficie);

        panelInput.add(new JLabel("Aggiungi Ortaggio (es. Pomodoro):"));
        JPanel panelOrtaggio = new JPanel(new BorderLayout());
        txtOrtaggio = new JTextField();
        JButton btnAddOrtaggio = new JButton("AGGIUNGI");
        panelOrtaggio.add(txtOrtaggio, BorderLayout.CENTER);
        panelOrtaggio.add(btnAddOrtaggio, BorderLayout.EAST);
        panelInput.add(panelOrtaggio);

        add(panelInput, BorderLayout.NORTH);

        // --- Lista Visuale (Centro) ---
        listModel = new DefaultListModel<>();
        JList<String> listaVisuale = new JList<>(listModel);
        listaVisuale.setBorder(BorderFactory.createTitledBorder("Colture Selezionate:"));
        add(new JScrollPane(listaVisuale), BorderLayout.CENTER);

        // --- Bottone Conferma (Sud) ---
        JButton btnConferma = new JButton("SALVA PROGETTO");
        btnConferma.setBackground(new Color(100, 200, 100)); // Verde chiaro
        btnConferma.setFont(new Font("Arial", Font.BOLD, 14));
        // Aggiungiamo un pannello per dare margine al bottone
        JPanel panelBtn = new JPanel(new BorderLayout());
        panelBtn.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
        panelBtn.add(btnConferma, BorderLayout.CENTER);
        add(panelBtn, BorderLayout.SOUTH);

        // --- 1. Logica Aggiungi Coltura alla lista temporanea ---
        btnAddOrtaggio.addActionListener(e -> {
            String nome = txtOrtaggio.getText().trim();
            if (!nome.isEmpty()) {
                // Creiamo una Coltura temporanea
                Coltura c = new Coltura();
                c.setTipoOrtaggio(nome); // Assicurati che questo setter esista in Coltura.java

                // Aggiungiamo alla lista logica e a quella visuale
                listaColtureTemp.add(c);
                listModel.addElement(nome);

                // Puliamo il campo
                txtOrtaggio.setText("");
            }
        });

        // --- 2. Logica Salva Progetto (Chiama il Controller) ---
        btnConferma.addActionListener(e -> {
            try {
                // Creazione oggetto Lotto dai dati input
                // Assicurati che Lotto.java abbia un costruttore vuoto o usa quello completo
                Lotto lotto = new Lotto();
                lotto.setIdLotto(Integer.parseInt(txtIdLotto.getText()));
                lotto.setSuperficie(Double.parseDouble(txtSuperficie.getText()));

                // Validazione base
                if (listaColtureTemp.isEmpty()) {
                    JOptionPane.showMessageDialog(this, "Inserisci almeno una coltura!", "Attenzione", JOptionPane.WARNING_MESSAGE);
                    return;
                }

                // CHIAMATA AL CONTROLLER
                boolean esito = controller.CreaProgettoStagionale(lotto, listaColtureTemp);

                if (esito) {
                    JOptionPane.showMessageDialog(this, "Progetto creato con successo!");
                    dispose(); // Chiude la finestra
                } else {
                    JOptionPane.showMessageDialog(this, "Errore: Terreno non adatto o Lotto non valido.", "Errore", JOptionPane.ERROR_MESSAGE);
                }
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(this, "Inserisci valori numerici validi per ID e Superficie.", "Errore Input", JOptionPane.WARNING_MESSAGE);
            } catch (Exception ex) {
                ex.printStackTrace(); // Utile per debug
                JOptionPane.showMessageDialog(this, "Errore generico: " + ex.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
            }
        });
    }
}
